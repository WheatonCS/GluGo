<html>
    <header>
      <title>Report</title>
      <link rel="stylesheet" type="text/css" href="reportstyle.css" />
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
      <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
      <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <script type="text/javascript" src="datepicker/js/jquery.js"></script>
      <link rel="stylesheet" media="screen" type="text/css" href="datepicker/css/datepicker.css" />
      <script type="text/javascript" src="datepicker/js/datepicker.js"></script>
      <script src="https://d3js.org/d3.v4.min.js"></script>
      <script src="box.js"></script>
    </header>

    <body>
		<div class="hamburgler-menu">
			<table id="tablemenu">
				<tr>
					<td id="basicsettings">
						<div class="menu">
						  <ul>
							<a href="javascript:setOverview()"><li>OVERVIEW</li></a>
							<a href="javascript:setDaily()"><li>DAILY</li></a>
							<a href="javascript:setWeekly()"><li>WEEKLY</li></a>
							<a href="javascript:setPie()"><li>PIE GRAPHS</li></a>
							<a href="javascript:setBox()"><li>BOXPLOTS</li></a>
						  </ul>
						</div> 
					</td>
					<td id="calendarselect">
					<p>Choose dates to graph:</p>
					<div id="calendar">
					</div>
					<p></p>
					<button id="submit" type="button" onclick="setCal()">Submit</button>
					</td>
				</tr>
			</table>
		</div>

    	<div class="header">
			<div id="hamburgler" class="hamburgler-icon-wrapper">
	  			<span class="hamburgler-icon"></span>
			</div>
    		<h1 id="title">TITLE OF GRAPH</h1>
    	</div>
		<div id="maindiv" class="main">
		<button id="left" onclick="goLeft()"><<</button>
		<button id="right" onclick="goRight()">>></button>
		</div>
		<div id="navbrush" class="nav">
		</div>
		<div id="footerstats" class="footer">
			<table id="stats">
				<tr>
					<td>
						<p class="statvalue" id="statone">6.4<span>%</span></p>
					</td>
					<td>
						<p class="statvalue" id="stattwo">137<span>mg/dL</span></p>
					</td>
					<td>
						<p class="statvalue" id="statthree">45<span>mg/dL</span></p>
					</td>
					<td>
						<table style="height:100%">
						<tr style="height:100%">
							<td style="height:100%; width:50%">
								<div class="progress vertical" id="bar1">
  							<div id="pbar1" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100" style="width: 33%;"></div>
  							</div>
  						</div>
							</td>
							<td style="height:100%; width:50%">
								<ul id="risk">
									<li id="highrisk">High</li>
									<li id="medrisk">Medium</li>
									<li id="lowrisk">Low</li>
  								</ul>
							</td>
						</tr>
						</table>
					</td>
					<td>
						<table id="range">
							<tr>
								<td>
									High
									<div class="progress" id="bar2">
						<div id="highbar" class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100" style="width: 23.3%;"><span style="color:black;">23.3%</span></div>
									</div>
								</td>
							</tr>
							<tr>
								<td>
								In range
								<div class="progress" id="bar2">
						<div id="medbar" class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100" style="width: 71.7%;"><span style="color:black;">71.7%</span></div>
									</div>
								</td>
							</tr>
							<tr>
								<td>
								Low
								<div class="progress" id="bar2">
						<div id="lowbar" class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100" style="width: 4.9%;"><span style="color:black;">4.9%</span></div>
									</div>
								</td>
							</tr>
						</table>
					</td>
					<td>
						<p class="statvalue" id="statsix">2.7</p>
					</td>
				</tr>
				<tr>
					<td>
						<p class="statlabel">Estimated A1C</p>
					</td>
					<td>
						<p class="statlabel">Average glucose (CGM)</p>
					</td>
					<td>
						<p class="statlabel">Standard deviation (CGM)</p>
					</td>
					<td>
  						<p class="statlabel" id="vertlabel">Hypoglycemia risk</p>
					</td>
					<td>
						<p class="statlabel" id="vertlabel">Time in range</p>
					</td>
					<td>
						<p class="statlabel">Average daily CGM calibrations</p>
					</td>
				</tr>
			</table>
		</div>
		
		
		<script>
			
			var map = {};
			
			var overview = true;
			var daily = false;
			var weekly = false;
			var cal = false;
			var pie = false;
			var box = false;
			
			var allDates = [];
			var allGluc = [];
			var allInfo = [];
			
			var allHigh = []
			var allLow = [];
			
			var allCalDates = [];
			var allCalGluc = [];
			var allCalInfo = [];
			var lastDateDay=0;
			var firstDateDay=0;
			var maxDateSec = 0;
			var minDateSec = 0;
			var maxDateDate = 0;
			var minDateDate = 0;
			var lastDateWeek=0;
			var firstDateWeek=0;
			
			var calDateMin = 0;
			var calDateMax = 0;
			var calSecMin = 0;
			var calSecMax = 0;
			
			var monthNames = ["January", "February", "March", "April", "May", "June",
 							 "July", "August", "September", "October", "November", "December"];
 							 
 			var MILLINDAY = 86400000;
 			var MILLINWEEK = MILLINDAY*7;
 			var MEDRISK = 80;
 			var HIGHRISK = 70;
			
			function readData()
			{
				var parseDate = d3.timeParse("%-m/%-d/%y %H:%M");
				d3.csv("mydata.csv", function(error, data) {
					data.forEach(function(d) {
						d.date = parseDate(d.date);
						allDates.push(d.date);
						d.glucose = +d.glucose;
						allGluc.push(d.glucose);
						d.high = +d.high;
						d.low = +d.low;
						allHigh.push({high:d.high, date:d.date});
						allLow.push({low:d.low, date:d.date});
						allInfo.push({date:d.date,glucose:d.glucose,high:d.high,low:d.low});
					});
				});
				
				d3.csv("mycaldata.csv", function(error, data) {
					data.forEach(function(d) {
						d.date = parseDate(d.date);
						allCalDates.push(d.date);
						d.glucose = +d.glucose;
						allCalGluc.push(d.glucose);
						d.high = +d.high;
						allHigh.push({high:d.high, date:d.date});
						allLow.push({low:d.low, date:d.date});
						allCalInfo.push({date:d.date,glucose:d.glucose, high:d.high,low:d.low});
					});
				});
				
				setTimeout(function() 
				{
				maxDateSec = allDates[allDates.length-1].getTime();
				maxDateDate = allDates[allDates.length-1];
				minDateSec = Math.min(allDates[0].getTime(), allCalDates[0].getTime());
				minDateDate = new Date(minDateSec);
				
				lastDateDay = allDates[allDates.length-1];
				lastDaySec = lastDateDay.getTime();
				dayBeforeSec = lastDaySec-MILLINDAY;
				firstDateDay = new Date(dayBeforeSec);
				
				lastDateWeek = lastDateDay;
				lastDateWeekSec = lastDateDay.getTime();
				firstDateWeekSec = lastDateWeekSec-MILLINWEEK;
				firstDateWeek = new Date(firstDateWeekSec);
				
				drawCanvas(allInfo);}, 200);
				//drawPieGraphs();}, 200);
				
			}
			
			function drawCanvas(data)
			{
				calcStats(data, allCalInfo, minDateDate, maxDateDate);
				document.getElementById('title').innerHTML = "Overview";
				document.getElementById("maindiv").innerHTML = "<button id='left' onclick='goLeft()'><<</button><button id='right' onclick='goRight()'>>></button>";
				document.getElementById("navbrush").innerHTML = "";
				
				canvasw = window.innerWidth
					|| document.documentElement.clientWidth
					|| document.body.clientWidth;

				canvash = window.innerHeight
					|| document.documentElement.clientHeight
					|| document.body.clientHeight;
			
				canvasmargin = {top: 40, right: 90, bottom: 40, left: 90},
					canvaswidth = canvasw - canvasmargin.left - canvasmargin.right,
					canvasheight = (.6*canvash) - canvasmargin.top - canvasmargin.bottom;
				
				var base = d3.select(".main");
				canvas = base.append("canvas")
					.attr("width", canvaswidth + canvasmargin.left + canvasmargin.right)
				   .attr("height", canvasheight + canvasmargin.top + canvasmargin.bottom);
				context = canvas.node().getContext("2d");
				
				var navHeight = 40
				var navChart = d3.select('.nav');
				navCanvas = navChart.append("canvas")								//add navigation chart to container chart
								.classed('chart', true)
								.classed('navigator', true)
								.attr("width", canvaswidth + canvasmargin.left + canvasmargin.right)
				   				.attr("height", navHeight + canvasmargin.top + canvasmargin.bottom);
				   				//.attr("transform", "translate(" + canvasmargin.left + "," + canvasmargin.top + ")");
				navcontext = navCanvas.node().getContext("2d");
				  
				var position = $('.nav').offset();
				
					  
				
				var canvasx = d3.scaleTime()
					.range([0, canvaswidth]);

				var canvasy = d3.scaleLinear()
					.range([canvasheight, 0]);
					
				var navx = d3.scaleTime().range([0, canvaswidth]);
				var navy = d3.scaleLinear().range([navHeight, 0]);
				
				

				var line = d3.line()
					.x(function(d) { return canvasx(d.date); })
					.y(function(d) { return canvasy(d.glucose); })
					.context(context);
					
				var navline = d3.line()
					.x(function(d) { return navx(d.date); })
					.y(function(d) { return navy(d.glucose); })
					.context(navcontext);

				context.translate(canvasmargin.left, canvasmargin.top);
				navcontext.translate(canvasmargin.left, canvasmargin.top);
				
				canvasx.domain([minDateDate, maxDateDate]);
				canvasy.domain([0, 400]);
				
				navx.domain([minDateDate, maxDateDate]);
				navy.domain([0, 400]);
				
				
				  
				navcontext.beginPath();
				  navline(data);
				  navcontext.lineWidth = 1.5;
				  navcontext.strokeStyle = "black";
				  navcontext.stroke();
				
				xAxis(canvasx, canvasy);
				//navxAxis(navx, navy);
				yAxis(canvasx, canvasy);
				
				var move = position.top + canvasmargin.top;
				
				map.svg =
				  d3.select('.nav')
					.append('svg')
					  .attr('width', canvaswidth + canvasmargin.left + canvasmargin.right)
					  .attr('height', navHeight+20)
					  .attr('style', 'z-index: 2;position:absolute;top:'+(+move)+'px;left:'+0)
					  .attr('transform', 'translate('+canvasmargin.left+',0)')
					  .append('g');
					  
				map.svg.append("g")
						.attr("class", "x axis")
						.attr("transform", "translate(0," + navHeight + ")")
						.call(d3.axisBottom(navx).ticks(7));
				
				var brush = d3.brushX()
					.extent([[0, 0], [canvaswidth, navHeight-1]])
					.on("brush", brushed);
					
				
				map.svg.append("g")
				  .attr("class", "brush")
				  .call(brush)
				  .call(brush.move, [0,canvaswidth] );										//on creation of "brush" rectangle, call brushed
					
					function brushed()
					{
						var brushmindate = 	d3.event.selection.map(navx.invert)[0];
						var brushmaxdate = 	d3.event.selection.map(navx.invert)[1];
						
						brushdata = allInfo.filter(function (el) 
						{
							return el.date.getTime() <= brushmaxdate.getTime() && el.date.getTime()>=brushmindate.getTime();
						});
						calbrushdata = allCalInfo.filter(function (el) 
						{
							return el.date.getTime() <= brushmaxdate.getTime() && el.date.getTime()>=brushmindate.getTime();
						});
						calcStats(brushdata, calbrushdata, brushmindate, brushmaxdate);
						context.clearRect(0, 0, canvas.width, canvas.height);
						document.getElementById("maindiv").innerHTML = "<button id='left' onclick='goLeft()'><<</button><button id='right' onclick='goRight()'>>></button>";
						
						canvasw = window.innerWidth
							|| document.documentElement.clientWidth
							|| document.body.clientWidth;

						canvash = window.innerHeight
							|| document.documentElement.clientHeight
							|| document.body.clientHeight;
			
						canvasmargin = {top: 40, right: 90, bottom: 40, left: 90},
							canvaswidth = canvasw - canvasmargin.left - canvasmargin.right,
							canvasheight = (.6*canvash) - canvasmargin.top - canvasmargin.bottom;
				
						var base = d3.select(".main");
						canvas = base.append("canvas")
							.attr("width", canvaswidth + canvasmargin.left + canvasmargin.right)
						   .attr("height", canvasheight + canvasmargin.top + canvasmargin.bottom);
						context = canvas.node().getContext("2d");
						
						var canvasx = d3.scaleTime()
							.range([0, canvaswidth]);

						var canvasy = d3.scaleLinear()
							.range([canvasheight, 0]);
						
						canvasx.domain([brushmindate, brushmaxdate]);
						canvasy.domain([0, 400]);
							
						var line = d3.line()
							.x(function(d) { return canvasx(d.date); })
							.y(function(d) { return canvasy(d.glucose); })
							.context(context);
						
						context.translate(canvasmargin.left, canvasmargin.top);
						
						context.beginPath();
						  line(brushdata);
						  context.lineWidth = 1.5;
						  context.strokeStyle = "steelblue";
						  context.stroke();
						  
						  xAxis(canvasx, canvasy);
						//navxAxis(navx, navy);
						yAxis(canvasx, canvasy);
			
						context.fillStyle = 'green';
						context.strokeWidth = 1;
						context.strokeStyle = 'green';
						
						calbrushdata.forEach(function(point) {
							drawPoint(point, 2, canvasx, canvasy);
					});
						
						
					};

				// if an index parameter is supplied, we only want to draw points
				// with indices in that array
				
					context.beginPath();
					  line(data);
					  context.lineWidth = 1.5;
					  context.strokeStyle = "steelblue";
					  context.stroke();
					  
					context.fillStyle = 'green';
					context.strokeWidth = 1;
					context.strokeStyle = 'green';
					
					allCalInfo.forEach(function(point) {
							drawPoint(point, 2, canvasx, canvasy);
					});
			}
			
			function drawPieGraphs()
			{
				document.getElementById('title').innerHTML = "Time in Range";
				d3.selectAll('#footerstats').style("visibility", "hidden");
				d3.selectAll('.footer').style("border-top", "none");
				document.getElementById("maindiv").innerHTML =  "<div>"+
        				"<button id='back' name='back' ><</button>"+
        				"<button id='forward' name='forward' >></button>"+
        				"<button id='key' name='key' onclick='clickKey()'>Key</button>"+
        				"<label id='currentMonth'>May 2013</label>"+
    					"</div><div id='chart'></div>";
				document.getElementById("navbrush").innerHTML = "";
				renderCalendarGrid();
				renderDaysOfMonth();
				$('#back').click(displayPreviousMonth);
				$('#forward').click(displayNextMonth);
			
			}
			
			function clickKey()
			{
				var myWindow = window.open("", "Key", "width=200,height=100");
				myWindow.document.write("<!DOCTYPE html>"+
						"<html>"+
						"<body>"+
						"<canvas id='myCanvas' width='150' height='70'>"+
						"</canvas>"+
						"</body>"+
						"</html>");
				
				var c=myWindow.document.getElementById('myCanvas');
				var ctx=c.getContext('2d');

				// Red rectangle
				ctx.beginPath();
				ctx.lineWidth='1';
				ctx.fillStyle=d3.schemeCategory10[2];
				ctx.rect(5,5,10,10); 
				ctx.fill();
				
				ctx.fillStyle='black';
				ctx.fillText("High",20,14);

				// Green rectangle
				ctx.beginPath();
				ctx.lineWidth='1';
				ctx.fillStyle=d3.schemeCategory10[1];
				ctx.rect(5,25,10,10); 
				ctx.fill();
				
				ctx.fillStyle='black';
				ctx.fillText("Low",20,34);

				// Blue rectangle
				ctx.beginPath();
				ctx.lineWidth='1';
				ctx.fillStyle= d3.schemeCategory10[0];
				ctx.rect(5,45,10,10); 
				ctx.fill();
				
				ctx.fillStyle='black';
				ctx.fillText("In range",20,54);

			}
			
			function drawPoint(point, r, canvasx, canvasy) {
				var cx = canvasx(point.date);
				var cy = canvasy(point.glucose);

				// NOTE; each point needs to be drawn as its own path
				// as every point needs its own stroke. you can get an insane
				// speed up if the path is closed after all the points have been drawn
				// and don't mind points not having a stroke
				context.beginPath();
				context.arc(cx, cy, r, 0, 2 * Math.PI);
				context.closePath();
				context.fill();
				context.stroke();
			}

			function xAxis(canvasx, canvasy) {
			  var tickCount = 10,
				  tickSize = 6,
				  ticks = canvasx.ticks(tickCount),
				  tickFormat = canvasx.tickFormat();

			  context.beginPath();
			  ticks.forEach(function(d) {
				context.moveTo(canvasx(d), canvasheight);
				context.lineTo(canvasx(d), canvasheight + tickSize);
			  });
			  context.strokeStyle = "black";
			  context.stroke();
			  
			  context.beginPath();
			  //context.moveTo(0, 0);
			  context.moveTo(0, canvasheight);
			  context.lineTo(canvaswidth, canvasheight);
			  context.lineTo(-tickSize, canvasheight);
			  context.strokeStyle = "black";
			  context.stroke();

			  context.textAlign = "center";
			  context.textBaseline = "top";
			  ticks.forEach(function(d) {
				context.fillText(tickFormat(d), canvasx(d), canvasheight + tickSize);
			  });
			}
			
			function navxAxis(navcanvasx, navcanvasy) {
			var navheight = 40
			  var tickCount = 10,
				  tickSize = 6,
				  ticks = navcanvasx.ticks(tickCount),
				  tickFormat = navcanvasx.tickFormat();

			  navcontext.beginPath();
			  ticks.forEach(function(d) {
				navcontext.moveTo(navcanvasx(d), navheight);
				navcontext.lineTo(navcanvasx(d), navheight + tickSize);
			  });
			  navcontext.strokeStyle = "black";
			  navcontext.stroke();
			  
			  navcontext.beginPath();
			  //context.moveTo(0, 0);
			  navcontext.moveTo(0, navheight);
			  navcontext.lineTo(canvaswidth, navheight);
			  navcontext.lineTo(-tickSize, navheight);
			  navcontext.strokeStyle = "black";
			  navcontext.stroke();

			  
			  navcontext.textAlign = "center";
			  navcontext.textBaseline = "top";
			  ticks.forEach(function(d) {
				navcontext.fillText(tickFormat(d), navcanvasx(d), navheight + tickSize);
			  });
			}

			function yAxis(canvasx, canvasy) {
			  var tickCount = 10,
				  tickSize = 6,
				  tickPadding = 3,
				  ticks = canvasy.ticks(tickCount),
				  tickFormat = canvasy.tickFormat(tickCount);
				
			  context.beginPath();
			  ticks.forEach(function(d) {
				context.moveTo(0, canvasy(d));
				context.lineTo(-6, canvasy(d));
			  });
			  context.strokeStyle = "black";
			  context.stroke();

			  
			  context.beginPath();
			  context.moveTo(-tickSize, 0);
			  context.lineTo(0.5, 0);
			  context.lineTo(0.5, canvasheight);
			  context.lineTo(-tickSize, canvasheight);
			  context.strokeStyle = "black";
			  context.stroke();
				
				
			  context.textAlign = "right";
			  context.textBaseline = "middle";
			  ticks.forEach(function(d) {
				context.fillText(tickFormat(d), -tickSize - tickPadding, canvasy(d));
			  });

			  context.save();
			  context.rotate(-Math.PI / 2);
			  context.textAlign = "right";
			  context.textBaseline = "top";
			  context.font = "bold 10px sans-serif";
			  context.fillText("Glucose (mg/dL)", -10, 10);
			  context.restore();
			}
			
			function goLeft()
			{
				if(daily)
				{
					
					newFirstDate = firstDateDay.getTime()-MILLINDAY;
					if(newFirstDate>=minDateSec)
					{
						lastDateDay = firstDateDay;
						firstDateDay = new Date(newFirstDate);
						drawDaily(allInfo);
					}
				}
				
				if(weekly)
				{
					newFirstDate = firstDateWeek.getTime()-MILLINWEEK;
					if(newFirstDate>=minDateSec)
					{
						lastDateWeek = firstDateWeek;
						firstDateWeek = new Date(newFirstDate);
						drawWeekly(allInfo);
					}
				}
			}
			
			function goRight()
			{
				if(daily)
				{
					newLastDate = lastDateDay.getTime()+MILLINDAY;
					if(newLastDate<=maxDateSec)
					{
						firstDateDay = lastDateDay;
						lastDateDay = new Date(newLastDate);
						
						drawDaily(allInfo);
					}
					
				}
				if(weekly)
				{
					newLastDate = lastDateWeek.getTime()+MILLINWEEK;
					if(newLastDate<=maxDateSec)
					{
						firstDateWeek = lastDateWeek;
						lastDateWeek = new Date(newLastDate);
						drawWeekly(allInfo);
					}
				}
			}
			
			function drawDaily(data)
			{	
				data = data.filter(function (el) 
				{
					return el.date.getTime() <= lastDateDay.getTime() && el.date.getTime()>=firstDateDay.getTime();
				});
				
				myCal = allCalInfo.filter(function (el) 
				{
					return el.date.getTime() <= lastDateDay.getTime() && el.date.getTime()>=firstDateDay.getTime();
				});
				
				myHigh = allHigh.filter(function (el) 
				{
					return el.date.getTime() <= lastDateDay.getTime() && el.date.getTime()>=firstDateDay.getTime();
				});
				
				myLow = allLow.filter(function (el) 
				{
					return el.date.getTime() <= lastDateDay.getTime() && el.date.getTime()>=firstDateDay.getTime();
				});
				d3.selectAll("svg").remove();
				calcStats(data, myCal, firstDateDay, lastDateDay);
				var day1 = (firstDateDay.getMonth()+1)+"/"+firstDateDay.getDate()+"/"+firstDateDay.getFullYear();
				var day2 = (lastDateDay.getMonth()+1)+"/"+lastDateDay.getDate()+"/"+lastDateDay.getFullYear();
				document.getElementById('title').innerHTML = "Daily: " + day1 + " - " + day2;
			// Set the dimensions of the canvas / graph
				var w = window.innerWidth
					|| document.documentElement.clientWidth
					|| document.body.clientWidth;

					var h = window.innerHeight
					|| document.documentElement.clientHeight
					|| document.body.clientHeight;
				
				var margin = {top: 40, right: 90, bottom: 40, left: 90},
					width = w - margin.left - margin.right,
					height = (.6*h) - margin.top - margin.bottom;

				// Parse the date / time
				//var parseDate = d3.time.format("%d-%b-%y").parse;

				// Set the ranges
				var x = d3.scaleTime().range([0, width]);
				var y = d3.scaleLinear().range([height, 0]);

				// Define the axes

				// Define the line
				var valueline = d3.line()
					.x(function(d) { return x(d.date); })
					.y(function(d) { return y(d.glucose); });
					
				var highline = d3.line()
					.x(function(d) { return x(d.date); })
					.y(function(d) { return y(d.high); });
					
				var lowline = d3.line()
					.x(function(d) { return x(d.date); })
					.y(function(d) { return y(d.low); });
	
				// Adds the svg canvas
				var svg = d3.select(".main")
					.append("div")
				   .append("svg")
				   .attr("width", width + margin.left + margin.right)
				   .attr("height", height + margin.top + margin.bottom)
				   .append("g")
				   .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

					// Scale the range of the data
					x.domain([firstDateDay, lastDateDay]);
					y.domain([0, 400]);

					// Add the valueline path.
					svg.append("path")
						.attr("class", "line")
						.attr("d", valueline(data))
						.attr("fill", "none")
						.attr('stroke', 'steelblue');
						
					svg.append("svg:path")
						.attr("class", "line")
						.attr("d", highline(myHigh))
						.attr('stroke', 'black');
						
					svg.append("path")
						.attr("class", "line")
						.attr("d", lowline(myLow))
						.attr('stroke', 'black');
					

					// Add the X Axis
					svg.append("g")
						.attr("class", "x axis")
						.attr("transform", "translate(0," +height+ ")")
						.call(d3.axisBottom(x).ticks(d3.timeMinute.every(60)));

					// Add the Y Axis
					svg.append("g")
						.attr("class", "y axis")
						.call(d3.axisLeft(y));
						
					svg.append("text")
						.attr("transform", "rotate(-90)")
						.attr("class", "label")
						.attr("y", (15))
						.attr("x",-10)
						.style("text-anchor", "end")
						.text("Glucose (mg/dL)");
					
					var tooltip = d3.select(".main").append("div")
						.attr("class", "tooltip")
						.style("opacity", 0);
    
					svg.selectAll(".dot")
					  .data(data)
					.enter().append("circle")
					  .attr("class", "dot")
					  .attr("r", 1)
					  .attr("cx", function(d) { return x(d.date); })
					  .attr("cy", function(d){ return y(d.glucose); })
					  .attr("stroke-width", 1)
					  .attr("stroke", "steelblue")
					  .style("fill", "none")
					  .on("mouseover", function(d) {
						  tooltip.transition()
							   .duration(200)
							   .style("opacity", .9);
						  tooltip.html(d.date + "<br>" + d.glucose)
							   .style("left", (d3.event.pageX + 5) + "px")
							   .style("top", (d3.event.pageY - 28) + "px");
					  })
					  .on("mouseout", function(d) {
						  tooltip.transition()
							   .duration(500)
							   .style("opacity", 0);
					  });
					  
					  svg.selectAll(".dot2")
					  .data(myCal)
					.enter().append("circle")
					  .attr("class", "dot")
					  .attr("r", 3)
					  .attr("cx", function(d) { return x(d.date); })
					  .attr("cy", function(d){ return y(d.glucose); })
					  .attr("stroke-width", 1)
					  .attr("stroke", "green")
					  .attr("opacity", .9)
					  .style("fill", "green")
					  .on("mouseover", function(d) {
						  tooltip.transition()
							   .duration(200)
							   .style("opacity", .9);
						  tooltip.html(d.date + "<br>" + d.glucose)
							   .style("left", (d3.event.pageX + 5) + "px")
							   .style("top", (d3.event.pageY - 28) + "px");
					  })
					  .on("mouseout", function(d) {
						  tooltip.transition()
							   .duration(500)
							   .style("opacity", 0);
					  });	
						
			}
			
			function drawWeekly(data)
			{	
				data = data.filter(function (el) 
				{
					return el.date.getTime() <= lastDateWeek.getTime() && el.date.getTime()>=firstDateWeek.getTime();
				});
				
				myCal = allCalInfo.filter(function (el) 
				{
					return el.date.getTime() <= lastDateWeek.getTime() && el.date.getTime()>=firstDateWeek.getTime();
				});
				
				myHigh = allHigh.filter(function (el) 
				{
					return el.date.getTime() <= lastDateWeek.getTime() && el.date.getTime()>=firstDateWeek.getTime();
				});
				
				myLow = allLow.filter(function (el) 
				{
					return el.date.getTime() <= lastDateWeek.getTime() && el.date.getTime()>=firstDateWeek.getTime();
				});
				
				calcStats(data, myCal, firstDateWeek, lastDateWeek);
				d3.selectAll("svg").remove();
				var day1 = (firstDateWeek.getMonth()+1)+"/"+firstDateWeek.getDate()+"/"+firstDateWeek.getFullYear();
				var day2 = (lastDateWeek.getMonth()+1)+"/"+lastDateWeek.getDate()+"/"+lastDateWeek.getFullYear();
				document.getElementById('title').innerHTML = "Weekly: " + day1 + " - " + day2;
			// Set the dimensions of the canvas / graph
				var w = window.innerWidth
					|| document.documentElement.clientWidth
					|| document.body.clientWidth;

					var h = window.innerHeight
					|| document.documentElement.clientHeight
					|| document.body.clientHeight;
			
				var margin = {top: 40, right: 90, bottom: 40, left: 90},
					width = w - margin.left - margin.right,
					height = (.6*h) - margin.top - margin.bottom;

				// Parse the date / time
				// Set the ranges
				var x = d3.scaleTime().range([0, width]);
				var y = d3.scaleLinear().range([height, 0]);

				// Define the axes

				// Define the line
				var valueline = d3.line()
					.x(function(d) { return x(d.date); })
					.y(function(d) { return y(d.glucose); });
				
				var highline = d3.line()
					.x(function(d) { return x(d.date); })
					.y(function(d) { return y(d.high); });
					
				var lowline = d3.line()
					.x(function(d) { return x(d.date); })
					.y(function(d) { return y(d.low); });
	
				// Adds the svg canvas
				var svg = d3.select(".main")
					.append("div")
				   .append("svg")
				   .attr("width", width + margin.left + margin.right)
				   .attr("height", height + margin.top + margin.bottom)
				   .append("g")
				   .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

					// Scale the range of the data
					x.domain([firstDateWeek, lastDateWeek]);
					y.domain([0, 400]);

					// Add the valueline path.
					svg.append("path")
						.attr("class", "line")
						.attr("d", valueline(data))
						.attr("fill", "none")
						.attr('stroke', 'steelblue');
						
					svg.append("svg:path")
						.attr("class", "line")
						.attr("d", highline(myHigh))
						.attr('stroke', 'black');
						
					svg.append("path")
						.attr("class", "line")
						.attr("d", lowline(myLow))
						.attr('stroke', 'black');

					// Add the X Axis
					svg.append("g")
						.attr("class", "x axis")
						.attr("transform", "translate(0," + height + ")")
						.call(d3.axisBottom(x).ticks(7));

					// Add the Y Axis
					svg.append("g")
						.attr("class", "y axis")
						.call(d3.axisLeft(y));
						
					svg.append("text")
						.attr("transform", "rotate(-90)")
						.attr("class", "label")
						.attr("y", (15))
						.attr("x",-10)
						.style("text-anchor", "end")
						.text("Glucose (mg/dL)");
					
					var tooltip = d3.select(".main").append("div")
						.attr("class", "tooltip")
						.style("opacity", 0);
    
					svg.selectAll(".dot")
					  .data(data)
					.enter().append("circle")
					  .attr("class", "dot")
					  .attr("r", 1)
					  .attr("cx", function(d) { return x(d.date); })
					  .attr("cy", function(d){ return y(d.glucose); })
					  .attr("stroke-width", 1)
					  .attr("stroke", "steelblue")
					  .style("fill", "none")
					  .on("mouseover", function(d) {
						  tooltip.transition()
							   .duration(200)
							   .style("opacity", .9);
						  tooltip.html(d.date + "<br>" + d.glucose)
							   .style("left", (d3.event.pageX + 5) + "px")
							   .style("top", (d3.event.pageY - 28) + "px");
					  })
					  .on("mouseout", function(d) {
						  tooltip.transition()
							   .duration(500)
							   .style("opacity", 0);
					  });
					  
					  svg.selectAll(".dot2")
					  .data(myCal)
					.enter().append("circle")
					  .attr("class", "dot")
					  .attr("r", 3)
					  .attr("cx", function(d) { return x(d.date); })
					  .attr("cy", function(d){ return y(d.glucose); })
					  .attr("stroke-width", 1)
					  .attr("stroke", "green")
					  .attr("opacity", .9)
					  .style("fill", "green")
					  .on("mouseover", function(d) {
						  tooltip.transition()
							   .duration(200)
							   .style("opacity", .9);
						  tooltip.html(d.date + "<br>" + d.glucose)
							   .style("left", (d3.event.pageX + 5) + "px")
							   .style("top", (d3.event.pageY - 28) + "px");
					  })
					  .on("mouseout", function(d) {
						  tooltip.transition()
							   .duration(500)
							   .style("opacity", 0);
					  });
						
			}
			
			function drawCal(data)
			{	
				data = data.filter(function (el) 
				{
					return el.date.getTime() <= calDateMax.getTime() && el.date.getTime()>=calDateMin.getTime();
				});
				
				myCal = allCalInfo.filter(function (el) 
				{
					return el.date.getTime() <= calDateMax.getTime() && el.date.getTime()>=calDateMin.getTime();
				});
				
				myHigh = allHigh.filter(function (el) 
				{
					return el.date.getTime() <= calDateMax.getTime() && el.date.getTime()>=calDateMin.getTime();
				});
				
				myLow = allLow.filter(function (el) 
				{
					return el.date.getTime() <= calDateMax.getTime() && el.date.getTime()>=calDateMin.getTime();
				});
				calcStats(data, myCal, firstDateWeek, lastDateWeek);
				d3.selectAll("svg").remove();
				var day1 = (calDateMin.getMonth()+1)+"/"+calDateMin.getDate()+"/"+calDateMin.getFullYear();
				var day2 = (calDateMax.getMonth()+1)+"/"+calDateMax.getDate()+"/"+calDateMax.getFullYear();
				document.getElementById('title').innerHTML = "Calendar Choice: " + day1 + " - " + day2;
			// Set the dimensions of the canvas / graph
				var w = window.innerWidth
					|| document.documentElement.clientWidth
					|| document.body.clientWidth;

					var h = window.innerHeight
					|| document.documentElement.clientHeight
					|| document.body.clientHeight;
			
				var margin = {top: 40, right: 90, bottom: 40, left: 90},
					width = w - margin.left - margin.right,
					height = (.6*h) - margin.top - margin.bottom;

				// Parse the date / time
				//var parseDate = d3.time.format("%d-%b-%y").parse;

				// Set the ranges
				var x = d3.scaleTime().range([0, width]);
				var y = d3.scaleLinear().range([height, 0]);


				// Define the line
				var valueline = d3.line()
					.x(function(d) { return x(d.date); })
					.y(function(d) { return y(d.glucose); });
				
				var highline = d3.line()
					.x(function(d) { return x(d.date); })
					.y(function(d) { return y(d.high); });
					
				var lowline = d3.line()
					.x(function(d) { return x(d.date); })
					.y(function(d) { return y(d.low); });
	
				// Adds the svg canvas
				var svg = d3.select(".main")
					.append("div")
				   .append("svg")
				   .attr("width", width + margin.left + margin.right)
				   .attr("height", height + margin.top + margin.bottom)
				   .append("g")
				   .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

					// Scale the range of the data
					x.domain([calDateMin, calDateMax]);
					y.domain([0, 400]);

					// Add the valueline path.
					svg.append("path")
						.attr("class", "line")
						.attr("d", valueline(data))
						.attr("fill", "none")
						.attr('stroke', 'steelblue');
						
					svg.append("svg:path")
						.attr("class", "line")
						.attr("d", highline(myHigh))
						.attr('stroke', 'black');
						
					svg.append("path")
						.attr("class", "line")
						.attr("d", lowline(myLow))
						.attr('stroke', 'black');

					// Add the X Axis
					svg.append("g")
						.attr("class", "x axis")
						.attr("transform", "translate(0," + height + ")")
						.call(d3.axisBottom(x));

					// Add the Y Axis
					svg.append("g")
						.attr("class", "y axis")
						.call(d3.axisLeft(y));
						
					svg.append("text")
						.attr("transform", "rotate(-90)")
						.attr("class", "label")
						.attr("y", (15))
						.attr("x",-10)
						.style("text-anchor", "end")
						.text("Glucose (mg/dL)");
					
					var tooltip = d3.select(".main").append("div")
						.attr("class", "tooltip")
						.style("opacity", 0);
    
					svg.selectAll(".dot")
					  .data(data)
					.enter().append("circle")
					  .attr("class", "dot")
					  .attr("r", 1)
					  .attr("cx", function(d) { return x(d.date); })
					  .attr("cy", function(d){ return y(d.glucose); })
					  .attr("stroke-width", 1)
					  .attr("stroke", "steelblue")
					  .style("fill", "none")
					  .on("mouseover", function(d) {
						  tooltip.transition()
							   .duration(200)
							   .style("opacity", .9);
						  tooltip.html(d.date + "<br>" + d.glucose)
							   .style("left", (d3.event.pageX + 5) + "px")
							   .style("top", (d3.event.pageY - 28) + "px");
					  })
					  .on("mouseout", function(d) {
						  tooltip.transition()
							   .duration(500)
							   .style("opacity", 0);
					  });
					  
					  svg.selectAll(".dot2")
					  .data(myCal)
					.enter().append("circle")
					  .attr("class", "dot")
					  .attr("r", 3)
					  .attr("cx", function(d) { return x(d.date); })
					  .attr("cy", function(d){ return y(d.glucose); })
					  .attr("stroke-width", 1)
					  .attr("stroke", "green")
					  .attr("opacity", .9)
					  .style("fill", "green")
					  .on("mouseover", function(d) {
						  tooltip.transition()
							   .duration(200)
							   .style("opacity", .9);
						  tooltip.html(d.date + "<br>" + d.glucose)
							   .style("left", (d3.event.pageX + 5) + "px")
							   .style("top", (d3.event.pageY - 28) + "px");
					  })
					  .on("mouseout", function(d) {
						  tooltip.transition()
							   .duration(500)
							   .style("opacity", 0);
					  });
						
			}
			
			function setDaily()
			{
				document.getElementById("maindiv").innerHTML = "<div id='maindiv' class='main'>" +
						"<button id='left' onclick='goLeft()'><<</button>"+
						"<button id='right' onclick='goRight()'>>></button>"+
						"</div>";
				d3.selectAll('#footerstats').style("visibility", "visible");
				d3.selectAll('.footer').style("border-top", "thin solid black");
				overview = false;
				daily = true;
				weekly = false;
				cal = false;
				pie = false;
				box = false;
				
				lastDateWeek = allDates[allDates.length-1];
				lastDateWeekSec = lastDateDay.getTime();
				firstDateWeekSec = lastDateWeekSec-MILLINWEEK;
				firstDateWeek = new Date(firstDateWeekSec);
				document.getElementById("maindiv").innerHTML = "<button id='left' onclick='goLeft()'><<</button><button id='right' onclick='goRight()'>>></button>";
				document.getElementById("navbrush").innerHTML = "";
				document.getElementById("right").style.visibility="visible";
				document.getElementById("left").style.visibility="visible";
				closeNav();
				drawDaily(allInfo);
			}
			
			function setOverview()
			{
				document.getElementById("maindiv").innerHTML = "<div id='maindiv' class='main'>" +
						"<button id='left' onclick='goLeft()'><<</button>"+
						"<button id='right' onclick='goRight()'>>></button>"+
						"</div>";
				d3.selectAll('#footerstats').style("visibility", "visible");
				d3.selectAll('.footer').style("border-top", "thin solid black");
				overview = true;
				daily = false;
				weekly = false;
				cal = false;
				pie = false;
				box = false;
				
				lastDateDay = allDates[allDates.length-1];
				lastDaySec = lastDateDay.getTime();
				dayBeforeSec = lastDaySec-MILLINDAY;
				firstDateDay = new Date(dayBeforeSec);
				
				lastDateWeek = lastDateDay;
				lastDateWeekSec = lastDateDay.getTime();
				firstDateWeekSec = lastDateWeekSec-MILLINWEEK;
				firstDateWeek = new Date(firstDateWeekSec);
				
				document.getElementById("navbrush").innerHTML = "";
				document.getElementById("right").style.visibility="hidden";
				document.getElementById("left").style.visibility="hidden";
				closeNav();
				drawCanvas(allInfo);
			}
			
			function setPie()
			{
				document.getElementById("maindiv").innerHTML = "<div id='maindiv' class='main'>" +
						"<button id='left' onclick='goLeft()'><<</button>"+
						"<button id='right' onclick='goRight()'>>></button>"+
						"</div>";
				overview = false;
				daily = false;
				weekly = false;
				cal = false;
				pie = true;
				box = false;
				
				lastDateDay = allDates[allDates.length-1];
				lastDaySec = lastDateDay.getTime();
				dayBeforeSec = lastDaySec-MILLINDAY;
				firstDateDay = new Date(dayBeforeSec);
				
				lastDateWeek = lastDateDay;
				lastDateWeekSec = lastDateDay.getTime();
				firstDateWeekSec = lastDateWeekSec-MILLINWEEK;
				firstDateWeek = new Date(firstDateWeekSec);
				
				document.getElementById("navbrush").innerHTML = "";
				document.getElementById("right").style.visibility="hidden";
				document.getElementById("left").style.visibility="hidden";
				closeNav();
				drawPieGraphs();
			}
			
			function setBox()
			{
				document.getElementById("maindiv").innerHTML = "<div id='maindiv' class='main'>" +
						"<button id='left' onclick='goLeft()'><<</button>"+
						"<button id='right' onclick='goRight()'>>></button>"+
						"</div>";
				overview = false;
				daily = false;
				weekly = false;
				cal = false;
				pie = false;
				box = true;
				
				lastDateDay = allDates[allDates.length-1];
				lastDaySec = lastDateDay.getTime();
				dayBeforeSec = lastDaySec-MILLINDAY;
				firstDateDay = new Date(dayBeforeSec);
				
				lastDateWeek = lastDateDay;
				lastDateWeekSec = lastDateDay.getTime();
				firstDateWeekSec = lastDateWeekSec-MILLINWEEK;
				firstDateWeek = new Date(firstDateWeekSec);
				
				document.getElementById("navbrush").innerHTML = "";
				document.getElementById("right").style.visibility="hidden";
				document.getElementById("left").style.visibility="hidden";
				closeNav();
				drawBox();
			}
			
			function drawBox()
			{
				
				document.getElementById("maindiv").innerHTML = "<div id='maindiv' class='main'>" +
						"<button id='left' onclick='goLeft()'><<</button>"+
						"<button id='right' onclick='goRight()'>>></button>"+
						"</div>";
				document.getElementById('title').innerHTML = "Boxplots";
				d3.selectAll('#footerstats').style("visibility", "hidden");
				d3.selectAll('.footer').style("border-top", "none");
				document.getElementById("navbrush").innerHTML = "";
				
				var labels = false; // show the text labels beside individual boxplots?

				var w = window.innerWidth
				|| document.documentElement.clientWidth
				|| document.body.clientWidth;

				var h = window.innerHeight
				|| document.documentElement.clientHeight
				|| document.body.clientHeight;

				var margin = {top: 30, right: 50, bottom: 70, left: 50};
				var  width = .9*w - margin.left - margin.right;
				var height = .9*h - margin.top - margin.bottom;
	
				var min = Infinity,
					max = -Infinity;
	
				// parse in the data	
				d3.csv("data.csv", function(error, csv) {
					// using an array of arrays with
					// data[n][2] 
					// where n = number of columns in the csv file 
					// data[i][0] = name of the ith column
					// data[i][1] = array of values of ith column

					var data = [];
					data[0] = [];
					data[1] = [];
					data[2] = [];
					data[3] = [];
					data[4] = [];
					data[5] = [];
					data[6] = [];
					data[7] = [];
					data[8] = [];
					data[9] = [];
					data[10] = [];
					data[11] = [];
					data[12] = [];
					data[13] = [];
					data[14] = [];
					data[15] = [];
					data[16] = [];
					data[17] = [];
					data[18] = [];
					data[19] = [];
					data[20] = [];
					data[21] = [];
					data[22] = [];
					data[23] = [];
					// add more rows if your csv file has more columns

					// add here the header of the csv file
					data[0][0] = "12AM";
					data[1][0] = "1AM";
					data[2][0] = "2AM";
					data[3][0] = "3AM";
					data[4][0] = "4AM";
					data[5][0] = "5AM";
					data[6][0] = "6AM";
					data[7][0] = "7AM";
					data[8][0] = "8AM";
					data[9][0] = "9AM";
					data[10][0] = "10AM";
					data[11][0] = "11AM";
					data[12][0] = "12PM";
					data[13][0] = "1PM";
					data[14][0] = "2PM";
					data[15][0] = "3PM";
					data[16][0] = "4PM";
					data[17][0] = "5PM";
					data[18][0] = "6PM";
					data[19][0] = "7PM";
					data[20][0] = "8PM";
					data[21][0] = "9PM";
					data[22][0] = "10PM";
					data[23][0] = "11PM";
					// add more rows if your csv file has more columns

					data[0][1] = [];
					data[1][1] = [];
					data[2][1] = [];
					data[3][1] = [];
					data[4][1] = [];
					data[5][1] = [];
					data[6][1] = [];
					data[7][1] = [];
					data[8][1] = [];
					data[9][1] = [];
					data[10][1] = [];
					data[11][1] = [];
					data[12][1] = [];
					data[13][1] = [];
					data[14][1] = [];
					data[15][1] = [];
					data[16][1] = [];
					data[17][1] = [];
					data[18][1] = [];
					data[19][1] = [];
					data[20][1] = [];
					data[21][1] = [];
					data[22][1] = [];
					data[23][1] = [];
  
					
					
					for(var i = 0; i < 24; i++)
					{
						data1 = allInfo.filter(function (el) 
						{
							return el.date.getHours() == i;
						});
						data2 = allCalInfo.filter(function (el) 
						{
							return el.date.getHours() == i;
						});
						for(var j = 0; j < data1.length; j++)
						{
							data[i][1].push(data1[j].glucose);
						}
						for(var j = 0; j < data2.length; j++)
						{
							data[i][1].push(data2[j].glucose);
						}
					}
					
  					var min = 0;
  					var max = 400;
  					var boxcolors = ["#FF7575","#FF9331","#F9BB00","#FFF06A",
										"#4AE371","#AAFD8E","#75ECFD","#BBBBFF",
										"#CD85FE","#EAA6EA","#FE98F1","#FF97CB"]

					var chart = d3.box(boxcolors)
						.whiskers(iqr(1.5))
						.height(height)	
						.domain([min, max])
						.showLabels(labels);

					var svg = d3.select("#maindiv").append("svg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
						.attr("class", "box")    
						.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	
		
					var x = d3.scaleBand()
								.domain( data.map(function(d) {return d[0] } ) )
								.rangeRound([0, width])	
								.paddingInner(.7)
								.paddingOuter(.3)	


					// the y-axis
					var y = d3.scaleLinear()
						.domain([min, max])
						.range([height + margin.top, 0 + margin.top]);


					// draw the boxplots	
					svg.selectAll(".box")	   
					  .data(data)
					  .attr("color", "red")
					  .enter().append("g")
					  	.attr("color", "red")
						.attr("transform", function(d) { return "translate(" +  x(d[0])  + "," + margin.top + ")"; } )
					  .call(chart.width(x.bandwidth())); 

 
					 // draw y axis
					svg.append("g")
						.attr("class", "y axis")
						.call(d3.axisLeft(y))
						.append("text") // and text1
						  .attr("transform", "rotate(-90)")
						  .attr("y", 6)
						  .attr("dy", ".71em")
						  .style("text-anchor", "end")
						  .style("font-size", "16px") 
						  .text("Revenue in â‚¬");		
	
					// draw x axis	
					svg.append("g")
					  .attr("class", "x axis")
					  .attr("transform", "translate(0," + (height  + margin.top + 10) + ")")
					  .call(d3.axisBottom(x))
					  .append("text")             // text label for the x axis
						.attr("x", (width / 2) )
						.attr("y",  10 )
						.attr("dy", ".71em")
						.style("text-anchor", "middle")
						.style("font-size", "16px") 
						.text("Quarter"); 
				});
			
			}
			
			function setWeekly()
			{
				document.getElementById("maindiv").innerHTML = "<div id='maindiv' class='main'>" +
						"<button id='left' onclick='goLeft()'><<</button>"+
						"<button id='right' onclick='goRight()'>>></button>"+
						"</div>";
				d3.selectAll('#footerstats').style("visibility", "visible");
				d3.selectAll('.footer').style("border-top", "thin solid black");
				overview = false;
				daily = false;
				weekly = true;
				cal = false;
				pie = false;
				box = false;
				
				lastDateDay = allDates[allDates.length-1];
				lastDaySec = lastDateDay.getTime();
				dayBeforeSec = lastDaySec-MILLINDAY;
				firstDateDay = new Date(dayBeforeSec);
				
				document.getElementById("navbrush").innerHTML = "";
				document.getElementById("maindiv").innerHTML = "<button id='left' onclick='goLeft()'><<</button><button id='right' onclick='goRight()'>>></button>";
				document.getElementById("right").style.visibility="visible";
				document.getElementById("left").style.visibility="visible";
				closeNav();
				drawWeekly(allInfo);
			}
			
			function setCal()
			{
				document.getElementById("maindiv").innerHTML = "<div id='maindiv' class='main'>" +
						"<button id='left' onclick='goLeft()'><<</button>"+
						"<button id='right' onclick='goRight()'>>></button>"+
						"</div>";
				d3.selectAll('#footerstats').style("visibility", "visible");
				d3.selectAll('.footer').style("border-top", "thin solid black");
				overview = false;
				daily = false;
				weekly = false;
				cal = true;
				pie = false;
				box = false;

				lastDateDay = allDates[allDates.length-1];
				lastDaySec = lastDateDay.getTime();
				dayBeforeSec = lastDaySec-MILLINDAY;
				firstDateDay = new Date(dayBeforeSec);
				var parseDate = d3.timeParse("%Y-%m-%d");
				calDateMin = parseDate($('#calendar').DatePickerGetDate(true)[0]);
				calDateMax = parseDate($('#calendar').DatePickerGetDate(true)[1]);
				calSecMin = calDateMin.getTime();
				calSecMax = calDateMax.getTime();
				
				document.getElementById("navbrush").innerHTML = "";
				document.getElementById("maindiv").innerHTML = "<button id='left' onclick='goLeft()'><<</button><button id='right' onclick='goRight()'>>></button>";
				document.getElementById("right").style.visibility="hidden";
				document.getElementById("left").style.visibility="hidden";
				closeNav();
				drawCal(allInfo);
			}
			
			function calcStats(data, cal, date1, date2)
			{
				var all = data.concat(cal);
				if(all.length >0)
				{
					var daysInRange = Math.floor((date2.getTime() - date1.getTime())/86400000)
					
					var avg = d3.mean(all,function(d) { return +d.glucose});
					document.getElementById('stattwo').innerHTML = avg.toFixed(1) + "<span>mg/dL</span>";
					var a1c = (avg + 46.7)/28.7;
					document.getElementById('statone').innerHTML = a1c.toFixed(1) + "<span>%</span>";
					var sd = d3.deviation(all,function(d) { return +d.glucose});
					document.getElementById('statthree').innerHTML = sd.toFixed(1) + "<span>mg/dL</span>";
					document.getElementById('statsix').innerHTML = (cal.length/daysInRange).toFixed(1);
					calcRisk(avg);
					calcTimeInRange(all);
				}
				else
				{
					document.getElementById('statone').innerHTML = "N/A";
					document.getElementById('stattwo').innerHTML = "N/A";
					document.getElementById('statthree').innerHTML = "N/A";
					document.getElementById("pbar1").className = "progress-bar progress-bar-danger";
					document.getElementById("pbar1").style.width = "0%";
					document.getElementById("lowrisk").style.color = "#D3D3D3";
					document.getElementById("medrisk").style.color = "#D3D3D3";
					document.getElementById("highrisk").style.color = "#D3D3D3";
					
					document.getElementById("highbar").style.width = "0%";
					document.getElementById("medbar").style.width = "0%";
					document.getElementById("lowbar").style.width = "0%";
					
					document.getElementById('highbar').innerHTML =" <span style='color:black;'>N/A</span>";
					document.getElementById('medbar').innerHTML =" <span style='color:black;'>N/A</span>";
					document.getElementById('lowbar').innerHTML =" <span style='color:black;'>N/A</span>";
					
					document.getElementById('statsix').innerHTML = "N/A";
				}
			}
			
			function calcRisk(avg)
			{
				if(avg<HIGHRISK)
				{
					document.getElementById("pbar1").className = "progress-bar progress-bar-danger";
					document.getElementById("pbar1").style.width = "100%";
					document.getElementById("lowrisk").style.color = "#D3D3D3";
					document.getElementById("medrisk").style.color = "#D3D3D3";
					document.getElementById("highrisk").style.color = "black";
				}
				else if(avg < MEDRISK)
				{
					document.getElementById("pbar1").className = "progress-bar progress-bar-warning";
					document.getElementById("pbar1").style.width = "66.6%";
					document.getElementById("lowrisk").style.color = "#D3D3D3";
					document.getElementById("medrisk").style.color = "black";
					document.getElementById("highrisk").style.color = "#D3D3D3";
				}
				else
				{
					document.getElementById("pbar1").className = "progress-bar progress-bar-success";
					document.getElementById("pbar1").style.width = "33.3%";
					document.getElementById("lowrisk").style.color = "black";
					document.getElementById("medrisk").style.color = "#D3D3D3";
					document.getElementById("highrisk").style.color = "#D3D3D3";
				}
			}
			
			function calcTimeInRange(data)
			{
				var length = data.length;
				var inrange = 0;
				var highrange = 0;
				var lowrange = 0;
				if(length > 0)
				{
					higharray = data.filter(function (el) 
					{
						return el.glucose > el.high;
					});
					
					inrangearray = data.filter(function (el) 
					{
						return el.glucose <= el.high && el.glucose>= el.low;
					});
					
					lowarray = data.filter(function (el) 
					{
						return el.glucose < el.low;
					});
					
					inrange = inrangearray.length/length*100;
					highrange = higharray.length/length*100;
					lowrange = lowarray.length/length*100;
					
					document.getElementById("highbar").style.width = highrange+"%";
					document.getElementById("medbar").style.width = inrange+"%";
					document.getElementById("lowbar").style.width = lowrange+"%";
					
					document.getElementById('highbar').innerHTML =" <span style='color:black;'>"+highrange.toFixed(1)+"%</span>";
					document.getElementById('medbar').innerHTML =" <span style='color:black;'>"+inrange.toFixed(1)+"%</span>";
					document.getElementById('lowbar').innerHTML =" <span style='color:black;'>"+lowrange.toFixed(1)+"%</span>";
				}
			}
			
			function iqr(k) {
			  return function(d, i) {
				var q1 = d.quartiles[0],
					q3 = d.quartiles[2],
					iqr = (q3 - q1) * k,
					i = -1,
					j = d.length;
				while (d[++i] < q1 - iqr);
				while (d[--j] > q3 + iqr);
				return [i, j];
			  };
			}
			
			function redraw()
			{
				if(overview)
					drawCanvas(allInfo);
					//drawOverview(allInfo);
				else if(daily)
					drawDaily(allInfo);
				else if(weekly)
					drawWeekly(allInfo);
				else if(cal)
					drawCal(allInfo);
				else if(box)
					drawBox();
				//drawPieGraphs();
			}
			
			readData();
			window.addEventListener("resize", redraw);
			
			
			// Revealing module pattern to store some global data that will be shared between different functions.
        var d3CalendarGlobals = function() {
            var calendarWidth = 1380, 
            calendarHeight = 820,
            gridXTranslation = 10,
            gridYTranslation = 40,
            cellColorForCurrentMonth = '#EAEAEA',
            cellColorForPreviousMonth = '#FFFFFF',
            counter = 0, // Counter is used to keep track of the number of "back" and "forward" button presses and to calculate the month to display.
            currentMonth = new Date().getMonth(),
            monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
            datesGroup;

            function publicCalendarWidth() { return calendarWidth; }
            function publicCalendarHeight() { return calendarHeight; }
            function publicGridXTranslation() { return gridXTranslation; }
            function publicGridYTranslation() { return gridYTranslation; }
            function publicGridWidth() { return calendarWidth - 10; }
            function publicGridHeight() { return calendarHeight - 40; }
            function publicCellWidth() { return publicGridWidth() / 7; }
            function publicCellHeight() { return publicGridHeight() / 5; }
            function publicGetDatesGroup() {
                return datesGroup;
            }
            function publicSetDatesGroup(value) {
                datesGroup = value;
            }
            function publicIncrementCounter() { counter = counter + 1; }
            function publicDecrementCounter() { counter = counter - 1; }
            function publicMonthToDisplay() {
                var dateToDisplay = new Date();
                // We use the counter that keep tracks of "back" and "forward" presses to get the month to display.
                dateToDisplay.setMonth(currentMonth + counter);
                return dateToDisplay.getMonth();
            }
            function publicMonthToDisplayAsText() { return monthNames[publicMonthToDisplay()]; }
            function publicYearToDisplay() {
                var dateToDisplay = new Date();
                // We use the counter that keep tracks of "back" and "forward" presses to get the year to display.
                dateToDisplay.setMonth(currentMonth + counter);
                return dateToDisplay.getFullYear();
            }
            function publicGridCellPositions() {

                // We store the top left positions of a 7 by 5 grid. These positions will be our reference points for drawing
                // various objects such as the rectangular grids, the text indicating the date etc.
                var cellPositions = [];
                for (y = 0; y < 5; y++) {
                    for (x = 0; x < 7; x++) {
                        cellPositions.push([x * publicCellWidth(), y * publicCellHeight()]);
                    }
                }

                return cellPositions;
            }

            // This function generates all the days of the month. But since we have a 7 by 5 grid, we also need to get some of
            // the days from the previous month and the next month. This way our grid will have all its cells filled. The days
            // from the previous or the next month will have a different color though. 
            function publicDaysInMonth() {
                var daysArray = [];

                var firstDayOfTheWeek = new Date(publicYearToDisplay(), publicMonthToDisplay(), 1).getDay();
                var daysInPreviousMonth = new Date(publicYearToDisplay(), publicMonthToDisplay(), 0).getDate();

                // Lets say the first week of the current month is a Wednesday. Then we need to get 3 days from 
                // the end of the previous month. But we can't naively go from 29 - 31. We have to do it properly
                // depending on whether the last month was one that had 31 days, 30 days or 28.
                for (i = 1; i <= firstDayOfTheWeek; i++) {
                    daysArray.push([daysInPreviousMonth - firstDayOfTheWeek + i, cellColorForCurrentMonth]);
                }
                
                // These are all the days in the current month.
                var daysInMonth = new Date(publicYearToDisplay(), publicMonthToDisplay() + 1, 0).getDate();
                for (i = 1; i <= daysInMonth; i++) {
                    daysArray.push([i, cellColorForPreviousMonth]);
                }

                // Depending on how many days we have so far (from previous month and current), we will need
                // to get some days from next month. We can do this naively though, since all months start on
                // the 1st.
                var daysRequiredFromNextMonth = 35 - daysArray.length;

                for (i = 1; i <= daysRequiredFromNextMonth; i++) {
                    daysArray.push([i,cellColorForCurrentMonth]);
                }

                return daysArray.slice(0,35);
            }

            return {
                calendarWidth: publicCalendarWidth(),
                calendarHeight: publicCalendarHeight(),
                gridXTranslation :publicGridXTranslation(),
                gridYTranslation :publicGridYTranslation(),
                gridWidth :publicGridWidth(),
                gridHeight :publicGridHeight(),
                cellWidth :publicCellWidth(),
                cellHeight :publicCellHeight(),
                getDatesGroup : publicGetDatesGroup,
                setDatesGroup: publicSetDatesGroup,
                incrementCounter : publicIncrementCounter,
                decrementCounter : publicDecrementCounter,
                monthToDisplay : publicMonthToDisplay(),
                monthToDisplayAsText : publicMonthToDisplayAsText,
                yearToDisplay: publicYearToDisplay,
                gridCellPositions: publicGridCellPositions(),
                daysInMonth : publicDaysInMonth
            }
        }();


        function displayPreviousMonth() {
            // We keep track of user's "back" and "forward" presses in this counter
            d3CalendarGlobals.decrementCounter();
            renderDaysOfMonth();
        }

        function displayNextMonth(){
            // We keep track of user's "back" and "forward" presses in this counter
            d3CalendarGlobals.incrementCounter();
            renderDaysOfMonth();
        }

        // This function is responsible for rendering the days of the month in the grid.
        function renderDaysOfMonth(month, year) {
            $('#currentMonth').text(d3CalendarGlobals.monthToDisplayAsText() + ' ' + d3CalendarGlobals.yearToDisplay());
            // We get the days for the month we need to display based on the number of times the user has pressed
            // the forward or backward button.
            var daysInMonthToDisplay = d3CalendarGlobals.daysInMonth();
            var cellPositions = d3CalendarGlobals.gridCellPositions;

            // All text elements representing the dates in the month are grouped together in the "datesGroup" element by the initalizing
            // function below. The initializing function is also responsible for drawing the rectangles that make up the grid.
            d3CalendarGlobals.datesGroup 
             .selectAll("text")
             .data(daysInMonthToDisplay)
             .attr("x", function (d,i) { return cellPositions[i][0]; })
             .attr("y", function (d,i) { return cellPositions[i][1]; })
             .attr("dx", 20) // right padding
             .attr("dy", 20) // vertical alignment : middle
             .attr("transform", "translate(" + d3CalendarGlobals.gridXTranslation + "," + d3CalendarGlobals.gridYTranslation + ")")
             .text(function (d) { return d[0]; }); // Render text for the day of the week

            d3CalendarGlobals.calendar
             .selectAll("rect")
             .data(daysInMonthToDisplay)
            // Here we change the color depending on whether the day is in the current month, the previous month or the next month.
            // The function that generates the dates for any given month will also specify the colors for days that are not part of the
            // current month. We just have to use it to fill the rectangle
             .style("fill", function (d) { return d[1]; }); 

            drawGraphsForMonthlyData();

        }

        function drawGraphsForMonthlyData() {
            // Get some random data
            var data = getDataForMonth();
            
            // Set up variables required to draw a pie chart
            var outerRadius = d3CalendarGlobals.cellWidth / 3;
            var innerRadius = 0;
            var pie = d3.pie();
            var color =  d3.scaleOrdinal(d3.schemeCategory10);
            var arc = d3.arc().innerRadius(innerRadius).outerRadius(outerRadius);
            // We need to index and group the pie charts and slices generated so that they can be rendered in
            // the appropriate cells. To do that, we call D3's 'pie' function of each of the data elements.
            var indexedPieData = [];

            for (i = 0; i < data.length; i++) {
                var pieSlices = pie(data[i]);
                // This loop is to store an index (j) for each of the slices of a given pie chart. Two different charts
                // on two different days will have the the same set of numbers for slices (eg: 0,1,2). This will help us
                // pick the same colors for the slices for two independent charts. Otherwise, the colors of the slices
                // will be different each day.
                for (j = 0; j < pieSlices.length; j++) {
                    indexedPieData.push([pieSlices[j], i, j]);
                }
            }
            
            var tooltip = d3.select("#chart").append("div")
						.attr("class", "tooltip")
						.style("opacity", 0);
            
            var cellPositions = d3CalendarGlobals.gridCellPositions;

            d3CalendarGlobals.chartsGroup
                    .selectAll("g.arc")
                    .remove();

            var arcs = d3CalendarGlobals.chartsGroup.selectAll("g.arc")
                          // use the indexed data so that each pie chart can be draw in a different cell and therefore for a different day
                          .data(indexedPieData)
                          .enter()
                          .append("g")
                          .attr("class", "arc")
                          .attr("transform", function (d) {
                              // This is where we use the index here to translate the pie chart and rendere it in the appropriate cell. 
                              // Normally, the chart would be squashed up against the top left of the cell, obscuring the text that shows the day of the month.
                              // We use the gridXTranslation and gridYTranslation and multiply it by a factor to move it to the center of the cell. There is probably
                              // a better way of doing this though.
                              var currentDataIndex = d[1];
                              return "translate(" +  (outerRadius + d3CalendarGlobals.gridXTranslation * 5 + cellPositions[currentDataIndex][0]) + ", " +  (outerRadius + d3CalendarGlobals.gridYTranslation * 1.25 + cellPositions[currentDataIndex][1]) + ")";
                          });
			
            arcs.append("path")
                .attr("fill", function (d, i) {
                    // The color is generated using the second index. Each slice of the pie is given a fixed number. This applies to all charts (see the indexing loop above).
                    // This way, by using the index we can generate teh same colors for each of the slices for different charts on different days.
                    return color(d[2]);
                })
                .attr("d", function (d, i) {
                    // Standard functions for drawing a pie charts in D3.
                    return arc(d[0]);
                });

            var indexkey = ["In range: ", "High: ", "Low: "]
            arcs.on("mouseover", function(d) {
						  tooltip.transition()
							   .duration(200)
							   .style("opacity", .9);
						  tooltip.html(indexkey[d[2]] + d[0].value.toFixed(1) + "%<br>")
							   .style("left", (d3.event.pageX + 5) + "px")
							   .style("top", (d3.event.pageY - 28) + "px");
					  })
					  .on("mouseout", function(d) {
						  tooltip.transition()
							   .duration(500)
							   .style("opacity", 0);
					  });
                
            

        }

        // Generates some random data that can be used to draw pie charts.
        function getDataForMonth() {
            var randomData = [];
            var monthdata = d3CalendarGlobals.daysInMonth();
            
            monthnow = false;
            var m = d3CalendarGlobals.monthToDisplayAsText();
            m = new Date(Date.parse(m +" 1, 2012")).getMonth()-1
            var y = d3CalendarGlobals.yearToDisplay()
            if(m == -1)
            {
            	curmonth = 11;
            	y = y-1;
            }
            for (var i = 0; i < 35; i++) 
            {
                var d = monthdata[i][0]
                if(d == 1)
                {
                	monthnow = true;
                	m = d3CalendarGlobals.monthToDisplayAsText();
            		m = new Date(Date.parse(m +" 1, 2012")).getMonth()
            		if(m == 0)
            			y = y+1;
                }
                var data = allInfo.filter(function (el) 
				{
					return (el.date.getMonth() == m && el.date.getFullYear() == y && el.date.getDate() == d)
				});
				var data2 = allCalInfo.filter(function (el) 
				{
					return (el.date.getMonth() == m && el.date.getFullYear() == y && el.date.getDate() == d)
				});
				var all = data.concat(data2);
				var length = all.length;
				var inrange = 0;
				var highrange = 0;
				var lowrange = 0;
				if(length > 0)
				{
					higharray = all.filter(function (el) 
					{
						return el.glucose > el.high;
					});
					
					inrangearray = all.filter(function (el) 
					{
						return el.glucose <= el.high && el.glucose>= el.low;
					});
					
					lowarray = all.filter(function (el) 
					{
						return el.glucose < el.low;
					});
					
					inrange = inrangearray.length/length*100;
					highrange = higharray.length/length*100;
					lowrange = lowarray.length/length*100;
					randomData.push([inrange,highrange,lowrange]);
				}
				else
					randomData.push([0,0,0]);
                /*if(monthnow)
                	randomData.push([30,d,70-d]);
                else
                	randomData.push([10,10,80]);*/
            }
			return randomData;
        }

        // This is the initializing function. It adds an svg element, draws a set of rectangles to form the calendar grid,
        // puts text in each cell representing the date and does the initial rendering of the pie charts.
        function renderCalendarGrid(month, year) {
            // Add the svg element.
            d3CalendarGlobals.calendar = d3.select("#chart")
                         .append("svg")
                         .attr("class", "calendar")
                         .attr("width", d3CalendarGlobals.calendarWidth )
                         .attr("height", d3CalendarGlobals.calendarHeight)
                         .append("g");

            // Cell positions are generated and stored globally because they are used by other functions as a reference to render different things.
            var cellPositions = d3CalendarGlobals.gridCellPositions;

            // Draw rectangles at the appropriate postions, starting from the top left corner. Since we want to leave some room for the heading and buttons,
            // use the gridXTranslation and gridYTranslation variables.
            d3CalendarGlobals.calendar.selectAll("rect")
                    .data(cellPositions)
                    .enter()
                    .append("rect")
                    .attr("x", function (d) { return d[0]; })
                    .attr("y", function (d) { return d[1]; })
                    .attr("width", d3CalendarGlobals.cellWidth)
                    .attr("height", d3CalendarGlobals.cellHeight)
                    .style("stroke", "#555")
                    .style("fill", "white") 
                    .attr("transform", "translate(" + d3CalendarGlobals.gridXTranslation + "," + d3CalendarGlobals.gridYTranslation + ")");

            var daysOfTheWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            // This adds the day of the week headings on top of the grid
            d3CalendarGlobals.calendar.selectAll("headers")
                 .data([0, 1, 2, 3, 4, 5, 6])
                 .enter().append("text")
                 .attr("x", function (d) { return cellPositions[d][0]; })
                 .attr("y", function (d) { return cellPositions[d][1]; })
                 .attr("dx", d3CalendarGlobals.gridXTranslation + 5) // right padding
                 .attr("dy", 30) // vertical alignment : middle
                 .text(function (d) { return daysOfTheWeek[d] });

            // The intial rendering of the dates for the current mont inside each of the cells in the grid. We create a named group ("datesGroup"),
            // and add our dates to this group. This group is also stored globally. Later on, when the the user presses the back and forward buttons
            // to navigate between the months, we clear and re add the new text elements to this group
            d3CalendarGlobals.datesGroup = d3CalendarGlobals.calendar.append("svg:g");
            var daysInMonthToDisplay = d3CalendarGlobals.daysInMonth();
            d3CalendarGlobals.datesGroup 
                 .selectAll("daysText")
                 .data(daysInMonthToDisplay)
                 .enter()
                 .append("text")
                 .attr("x", function (d, i) { return cellPositions[i][0]; })
                 .attr("y", function (d, i) { return cellPositions[i][1]; })
                 .attr("dx", 20) // right padding
                 .attr("dy", 20) // vertical alignment : middle
                 .attr("transform", "translate(" + d3CalendarGlobals.gridXTranslation + "," + d3CalendarGlobals.gridYTranslation + ")")
                 .text(function (d) { return d[0]; });

            // Create a new svg group to store the chart elements and store it globally. Again, as the user navigates through the months by pressing 
            // the "back" and "forward" buttons on the page, we clear the chart elements from this group and re add them again.
            d3CalendarGlobals.chartsGroup = d3CalendarGlobals.calendar.append("svg:g");
            // Call the function to draw the charts in the cells. This will be called again each time the user presses the forward or backward buttons.
            drawGraphsForMonthlyData();
        }
			</script>
		<script>
		  document.getElementById('hamburgler').addEventListener('click', checkNav);
		  window.addEventListener("keyup", function(e) {
			if (e.keyCode == 27) closeNav();
		  }, false);

		  function checkNav() {
			if (document.body.classList.contains('hamburgler-active')) {
			  closeNav();
			} else {
			  openNav();
			}
		  }

		  function closeNav() {
			document.body.classList.remove('hamburgler-active');
		  }

		  function openNav() {
			document.body.classList.add('hamburgler-active');
		  }
		</script>
		<script>
		$('#calendar').DatePicker({
			flat: true,
			date: ['2016-07-28','2016-07-31'],
			current: '2016-07-28',
			calendars: 1,
			mode: 'range',
			starts: 1
		});
		</script>
		<script>
		function myfunction() 
		{
    		alert("click");
		}
		</script>
    </body>
</html>